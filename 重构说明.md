# QQ音乐解密工具 - 重构说明

## 📋 重构总结

### 原始问题
- JavaScript Hook脚本存在兼容性问题
- Session对象API调用错误
- 代码结构混乱，不易维护

### 解决方案
将所有JavaScript逻辑迁移到Python类中，动态生成JavaScript代码。

## 🏗️ 新架构

### 文件结构
```
o:/A_python/A_QQd/
├── main.py                 # 主程序入口（3.7 KB）
├── qqmusic_decrypt.py      # 核心解密类（10.14 KB）✨
├── requirements.txt        # 依赖配置
├── README.md              # 使用文档（4.99 KB）
├── js/                    # 参考代码（仅作调试参考）
│   └── hook_qq_music.js   # 原始JS版本（6.88 KB）
├── output/                # 输出目录
│   ├── *.flac            # 解密后的FLAC文件
│   └── *.ogg             # 解密后的OGG文件
└── 重构说明.md           # 本文件
```

## 🔄 核心改动

### 1. 新增 `qqmusic_decrypt.py`
**QQMusicDecryptor类** - 封装所有解密逻辑

```python
from qqmusic_decrypt import QQMusicDecryptor

# 初始化解密器
decryptor = QQMusicDecryptor(session)

# 解密文件
success = decryptor.decrypt(src_file, dest_file)
```

**特性：**
- ✅ 在运行时动态生成JavaScript代码
- ✅ 自动查找QQMusicCommon.dll导出函数
- ✅ 支持多种函数名格式（不同编译器版本）
- ✅ 详细的调试输出
- ✅ 完整的错误处理

### 2. 修改 `main.py`
- 移除了复杂的JavaScript加载逻辑
- 改用 `QQMusicDecryptor` 类
- 代码更简洁清晰

### 3. 移动 `hook_qq_music.js`
- 移至 `js/` 目录
- **仅作参考，不会被Python调用**
- 保留原始实现供调试对比

## 🔧 技术实现

### JavaScript动态生成
Python代码在运行时动态生成JavaScript脚本：

```python
# 在Python中动态生成JS代码
script_code = f"""
var constructorAddr = ptr("{hex(self.functions['constructor'])}");
var Constructor = new NativeFunction(constructorAddr, "pointer", ["pointer"], "thiscall");
// ...
"""
```

### 函数查找流程
1. 在JavaScript中调用 `Process.findModuleByName()`
2. 枚举所有导出函数
3. Python端匹配函数名
4. 动态生成调用代码

### 支持的函数名格式
```python
# 构造函数
"??0EncAndDesMediaFile@@QAE@XZ"   # MSVC 2013
"??0EncAndDesMediaFile@@QEAA@XZ"  # MSVC 2017+

# 其他函数同理，支持多种修饰名格式
```

## 📊 对比

| 特性 | 原始版本 | 重构版本 |
|------|---------|---------|
| 代码结构 | JavaScript为主 | Python为主 |
| 文件依赖 | 需要外部js文件 | 完全自包含 |
| 可维护性 | 低 | 高 |
| 易用性 | 复杂 | 简单 |
| 函数查找 | 硬编码 | 自动匹配 |
| 调试输出 | 有限 | 详细 |
| 错误处理 | 基础 | 完整 |

## 🎯 优势

### 1. 完全Python化
- 所有逻辑都在Python中
- 易于理解和修改
- 符合Python编程习惯

### 2. 自包含
- 不需要任何外部JS文件
- 运行时动态生成所需代码
- 单一入口点

### 3. 自动适配
- 自动查找函数地址
- 支持多种函数名格式
- 兼容不同QQ音乐版本

### 4. 易于扩展
- 封装成类，易于复用
- 清晰的API接口
- 方便集成到其他项目

## 📝 使用方法

### 基本使用
```bash
# 安装依赖
pip install -r requirements.txt

# 运行（确保QQ音乐已启动）
python main.py
```

### 自定义集成
```python
import frida
from qqmusic_decrypt import QQMusicDecryptor

# 附加到QQ音乐
device = frida.get_local_device()
session = device.attach(qqmusic_pid)

# 创建解密器
decryptor = QQMusicDecryptor(session)

# 解密文件
decryptor.decrypt("input.mflac", "output.flac")
```

## 🔍 调试

如果遇到问题，可以查看：
1. **Python端输出** - 详细的函数查找过程
2. **JavaScript端输出** - 动态生成的脚本执行日志
3. **js/hook_qq_music.js** - 参考实现（对比排查）

## ✅ 测试验证

输出文件已成功生成：
- `output/input.flac` (24.13 MB)
- `output/LBI利比（时柏尘） - 妥协_EG.flac` (26.78 MB)
- `output/LBI利比（时柏尘） - 妥协_H.ogg` (9.96 MB)

证明程序工作正常！

## 📚 后续优化建议

1. 添加配置文件支持（自定义QQ音乐目录）
2. 支持更多音频格式
3. 添加图形界面
4. 批量处理进度显示
5. 错误重试机制

## 🎉 总结

本次重构将项目从JavaScript主导转变为Python主导，实现了：
- 代码完全自包含
- 动态生成JavaScript
- 更好的可维护性
- 更清晰的项目结构
- 更友好的使用体验
