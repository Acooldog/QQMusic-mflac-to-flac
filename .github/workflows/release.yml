name: Release Application

on:
  push:
    tags:
      - 'v*'  # 当推送 v 开头的标签时触发
  workflow_dispatch:  # 允许手动触发
    inputs:
      version:
        description: '版本号'
        required: true
        default: '1.0.0'

jobs:
  release-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check release file
      shell: pwsh
      run: |
        if (Test-Path "release\QQMusic-mflac-to-flac.zip") {
          Write-Host "找到本地 release 文件"
          $fileSize = (Get-Item "release\QQMusic-mflac-to-flac.zip").Length / 1MB
          Write-Host "ZIP 文件大小: $([math]::Round($fileSize, 2)) MB"
        }
        else {
          Write-Error "未找到 release/QQMusic-mflac-to-flac.zip 文件"
          Write-Error "请先在本地构建并准备好 release 包，然后再运行此 workflow"
          exit 1
        }

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: QQMusic-mflac-to-flac-${{ github.ref_name }}
        path: release/QQMusic-mflac-to-flac.zip
        retention-days: 7

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        files: release/QQMusic-mflac-to-flac.zip
        body: |
          # QQMusic mflac to flac Converter ${{ github.ref_name }}

          ## 下载

          ### Windows 用户
          1. 下载 [QQMusic-mflac-to-flac.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/QQMusic-mflac-to-flac.zip)
          2. 解压到任意文件夹
          3. 运行 `QQMusic-mflac-to-flac.exe`

          ## 文件说明

          | 文件 | 说明 |
          |------|------|
          | `QQMusic-mflac-to-flac.zip` | 完整发布包（包含主程序和插件） |

          ## 使用说明

          1. 解压 ZIP 包到任意文件夹
          2. 确保 QQ 音乐客户端正在运行
          3. 双击运行 `QQMusic-mflac-to-flac.exe`
          4. 在界面中选择 QQ 音乐下载目录和输出目录
          5. 点击"开始解密"按钮

          ## 配置说明

          - 程序会自动创建 `plugins/plugins.json` 配置文件
          - 如遇设置保存问题，请手动创建该文件（详见 README.md）
          - 支持的加密格式：.mflac（FLAC）、.mgg（OGG）

          ## 发布信息

          - 发布时间: ${{ github.event.head_commit.timestamp }}
          - 版本标签: ${{ github.ref_name }}